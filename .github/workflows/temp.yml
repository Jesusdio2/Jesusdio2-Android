name: Sync CellBroadcastReceiver from AOSP

on:
  workflow_dispatch:

jobs:
  sync-cellbroadcastreceiver:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout your repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Git
        run: |
          sudo apt-get update
          sudo apt-get install -y git

      - name: Clone CellBroadcastReceiver (AOSP main)
        run: |
          git clone --depth=1 https://android.googlesource.com/platform/packages/apps/CellBroadcastReceiver CellBroadcastReceiver

      - name: Copy into repo
        run: |
          mkdir -p packages/apps
          rm -rf packages/apps/CellBroadcastReceiver
          cp -r CellBroadcastReceiver packages/apps/
          rm -rf packages/apps/CellBroadcastReceiver/.git

      - name: Clean symlinks
        run: |
          find packages/apps/CellBroadcastReceiver -type l -exec rm -f {} \;

      - name: Commit and push (sync)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REF: ${{ github.ref }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/apps/CellBroadcastReceiver
          git commit -m "Sync CellBroadcastReceiver from latest AOSP main" || echo "No changes to commit"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}
          git pull --rebase origin ${GITHUB_REF} || true
          git push origin HEAD:${GITHUB_REF}
