name: AOSP Build (Self-Hosted)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: self-hosted   # usa tu runner autohospedado
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          export USE_CCACHE=1
          export CCACHE_DIR=$HOME/.ccache
          mkdir -p ~/.ccache
          ccache -M 100G

      - name: Initialize AOSP
        run: |
          mkdir -p $HOME/aosp && cd $HOME/aosp
          repo init -u https://android.googlesource.com/platform/manifest -b android16-release
          repo sync -j$(nproc)

      - name: Apply custom pm folder
        run: |
          cp -r $GITHUB_WORKSPACE/platform/frameworks/base/services/core/java/com/android/server/pm/* \
                $HOME/aosp/frameworks/base/services/core/java/com/android/server/pm/

      - name: Apply custom device tree
        run: |
          unzip -o $GITHUB_WORKSPACE/device.zip -d $HOME/aosp/device/

      - name: Build ROM
        run: |
          cd $HOME/aosp
          source build/envsetup.sh
          lunch aosp_arm64-eng
          make -j$(nproc)

      - name: Upload ROM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: aosp-rom
          path: $HOME/aosp/out/target/product/arm64/*.img
