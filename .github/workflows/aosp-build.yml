name: AOSP Full Build

on:
  workflow_dispatch:

jobs:
  prepare:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-11-jdk git-core gnupg flex bison gperf build-essential \
            zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 \
            lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache \
            libgl1-mesa-dev libxml2-utils xsltproc unzip python3

      - name: Download device tree
        run: |
          curl -L https://github.com/Jesusdio2/Jesusdio2-Android/releases/download/Dev0/device.zip -o device.zip
          unzip -o device.zip -d device/

      - name: Download AOSP frameworks/base
        run: |
          git clone https://android.googlesource.com/platform/frameworks/base frameworks-base
          cd frameworks-base
          git checkout android16-release

      - name: Replace pm folder with custom files
        run: |
          cp -r platform/frameworks/base/services/core/java/com/android/server/pm/* frameworks-base/services/core/java/com/android/server/pm/

  build-frameworks:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Build frameworks/base
        run: |
          source build/envsetup.sh || true
          lunch aosp_arm64-eng
          make frameworks-base -j$(nproc)

  build-services:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Build services/core
        run: |
          source build/envsetup.sh || true
          lunch aosp_arm64-eng
          make services -j$(nproc)

  build-device:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Build device/generic/arm64
        run: |
          source build/envsetup.sh || true
          lunch aosp_arm64-eng
          make generic_arm64 -j$(nproc)

  build-system:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Build system image
        run: |
          source build/envsetup.sh || true
          lunch aosp_arm64-eng
          make systemimage -j$(nproc)

  package-rom:
    runs-on: ubuntu-latest
    needs: [build-frameworks, build-services, build-device, build-system]
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Build full ROM
        run: |
          source build/envsetup.sh || true
          lunch aosp_arm64-eng
          make -j$(nproc)
      - name: Upload ROM artifact
        uses: actions/upload-artifact@v4
        with:
          name: aosp-rom
          path: out/target/product/arm64/*.img
