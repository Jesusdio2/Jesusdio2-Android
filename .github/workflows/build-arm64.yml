name: Build AOSP Modules Incremental

on:
  workflow_dispatch:

jobs:
  build-gmscore:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y openjdk-11-jdk git-core build-essential zip curl

      - name: Download AOSP minimal
        run: |
          mkdir aosp && cd aosp
          repo init -u https://android.googlesource.com/platform/manifest -b android-12.1.0_r1
          repo sync -j$(nproc) packages/apps/GmsCore frameworks/base system/sepolicy

      - name: Apply Android/data & obb patch
        run: |
          cd aosp
          git apply ../patches/allow_data_obb.patch

      - name: Copy GmsCore
        run: cp -r GmsCore aosp/packages/apps/GmsCore

      - name: Build GmsCore
        run: |
          cd aosp
          source build/envsetup.sh
          lunch aosp_arm64-eng
          make GmsCore -j$(nproc)

      - name: Upload GmsCore APK
        uses: actions/upload-artifact@v4
        with:
          name: GmsCore
          path: aosp/out/target/product/*/system/app/GmsCore/*.apk

      - name: Cleanup
        run: rm -rf aosp

  build-gsfproxy:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y openjdk-11-jdk git-core build-essential zip curl
      - name: Download AOSP minimal
        run: |
          mkdir aosp && cd aosp
          repo init -u https://android.googlesource.com/platform/manifest -b android-12.1.0_r1
          repo sync -j$(nproc) packages/apps/GsfProxy frameworks/base system/sepolicy
      - name: Apply Android/data & obb patch
        run: cd aosp && git apply ../patches/allow_data_obb.patch
      - name: Copy GsfProxy
        run: cp -r GsfProxy aosp/packages/apps/GsfProxy
      - name: Build GsfProxy
        run: |
          cd aosp
          source build/envsetup.sh
          lunch aosp_arm64-eng
          make GsfProxy -j$(nproc)
      - name: Upload GsfProxy APK
        uses: actions/upload-artifact@v4
        with:
          name: GsfProxy
          path: aosp/out/target/product/*/system/app/GsfProxy/*.apk
      - name: Cleanup
        run: rm -rf aosp

  build-aurora:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y openjdk-11-jdk git-core build-essential zip curl
      - name: Download AOSP minimal
        run: |
          mkdir aosp && cd aosp
          repo init -u https://android.googlesource.com/platform/manifest -b android-12.1.0_r1
          repo sync -j$(nproc) packages/apps/AuroraStore frameworks/base system/sepolicy
      - name: Apply Android/data & obb patch
        run: cd aosp && git apply ../patches/allow_data_obb.patch
      - name: Copy AuroraStore
        run: cp -r AuroraStore aosp/packages/apps/AuroraStore
      - name: Build AuroraStore
        run: |
          cd aosp
          source build/envsetup.sh
          lunch aosp_arm64-eng
          make AuroraStore -j$(nproc)
      - name: Upload AuroraStore APK
        uses: actions/upload-artifact@v4
        with:
          name: AuroraStore
          path: aosp/out/target/product/*/system/app/AuroraStore/*.apk
      - name: Cleanup
        run: rm -rf aosp
